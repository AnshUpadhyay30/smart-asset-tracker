<div class="admin-users-shell" role="main" aria-label="Admin Users">

  <!-- Breadcrumb + Export -->
  <header class="hdr">
    <div class="crumb">
      <span class="brand">SmartAsset</span>
      <span class="sep">›</span>
      <span class="trail">Admin</span>
      <span class="sep">›</span>
      <span class="trail current">Users</span>
    </div>

    <div class="hdr-actions" *ngIf="isAdmin()">
      <!-- ⬇️ Export: now wired -->
      <button mat-stroked-button type="button" class="btn-ghost"
              matTooltip="Export user list" (click)="exportCsv()">
        <mat-icon>download</mat-icon>
        <span>Export</span>
      </button>
    </div>
  </header>

  <!-- Title -->
  <div class="title-row">
    <div class="title">
      <span class="glyph" aria-hidden="true"><mat-icon>group</mat-icon></span>
      <div class="stack">
        <h2>Manage Users</h2>
        <p class="muted">Admins can create Managers/Techs, reset passwords and disable accounts.</p>
      </div>
    </div>
  </div>

  <!-- Tabs (Admin-only) -->
  <nav class="tabs card" *ngIf="isAdmin()" role="tablist" aria-label="User creation mode">
    <button role="tab" [attr.aria-selected]="tab() === 'single'" [class.active]="tab() === 'single'" (click)="tab.set('single')">
      Single Create
    </button>
    <button role="tab" [attr.aria-selected]="tab() === 'bulk'" [class.active]="tab() === 'bulk'" (click)="tab.set('bulk')">
      Bulk Create
    </button>
  </nav>

  <!-- Single Create (Admin-only) -->
  <section class="card create-card" *ngIf="tab() === 'single' && isAdmin()">
    <form class="user-form" [formGroup]="form" (ngSubmit)="createSingle()" autocomplete="off">
      <mat-form-field appearance="outline" class="w">
        <mat-label>Name</mat-label>
        <input matInput formControlName="name" required (blur)="autoSuggestUsername()">
      </mat-form-field>

      <mat-form-field appearance="outline" class="w">
        <mat-label>Email</mat-label>
        <input matInput formControlName="email" required (blur)="autoSuggestUsername()">
      </mat-form-field>

      <mat-form-field appearance="outline" class="w sm">
        <mat-label>Role</mat-label>
        <mat-select formControlName="role" required>
          <mat-option value="MANAGER">MANAGER</mat-option>
          <mat-option value="TECH">TECH</mat-option>
          <mat-option value="ADMIN">ADMIN</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="w">
        <mat-label>Username (auto suggested)</mat-label>
        <input matInput formControlName="username" placeholder="leave blank to auto">
      </mat-form-field>

      <mat-form-field appearance="outline" class="w">
        <mat-label>Temp password (optional)</mat-label>
        <input matInput formControlName="temp_password" placeholder="Auto-generate if blank">
      </mat-form-field>

      <div class="submit-wrap">
        <button mat-flat-button color="primary" class="btn-primary" [disabled]="form.invalid || creating()">
          <mat-icon>person_add</mat-icon>
          <span>Create User</span>
        </button>
        <span class="msg" *ngIf="createdPw()">Temp Password: <b>{{ createdPw() }}</b></span>
      </div>
    </form>
  </section>

  <!-- Bulk Create (Admin-only) -->
  <section class="card" *ngIf="tab() === 'bulk' && isAdmin()">
    <div class="bulk">
      <p class="hint">Paste CSV with headers: <code>name,email,role,username</code></p>

      <mat-form-field appearance="outline" class="w-full">
        <mat-label>CSV</mat-label>
        <textarea matInput [(ngModel)]="csv" rows="8"
          placeholder="name,email,role,username&#10;Rohit,rohit@example.com,MANAGER,rohit.ch&#10;Priya,priya@example.com,TECH,"></textarea>
      </mat-form-field>

      <div class="bulk-actions">
        <button mat-stroked-button class="btn-ghost" (click)="bulkCreateCsv()">Create from CSV</button>
        <button mat-flat-button color="primary" class="btn-primary" (click)="downloadCsvTemplate()">
          <mat-icon>download</mat-icon>
          <span>Template</span>
        </button>
      </div>
    </div>
  </section>

  <!-- Users table -->
  <section class="card table-card">
    <div class="table-head">
      <h3><mat-icon>groups</mat-icon> All Users</h3>
    </div>

    <div class="table-scroller">
      <table mat-table [dataSource]="rows()" class="mat-elevation-z1 pretty-table">

        <!-- Name & Email -->
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef sticky>Name & Email</th>
          <td mat-cell *matCellDef="let u">
            <div class="name">{{ u.name }}</div>
            <div class="email">{{ u.email }}</div>
          </td>
        </ng-container>

        <!-- Username -->
        <ng-container matColumnDef="username">
          <th mat-header-cell *matHeaderCellDef sticky>Username</th>
          <td mat-cell *matCellDef="let u">{{ u.username || '—' }}</td>
        </ng-container>

        <!-- Role -->
        <ng-container matColumnDef="role">
          <th mat-header-cell *matHeaderCellDef sticky>Role</th>
          <td mat-cell *matCellDef="let u">
            <mat-select [value]="u.role" (valueChange)="changeRole(u, $event)" class="inline-select" [disabled]="!isAdmin()">
              <mat-option value="ADMIN">ADMIN</mat-option>
              <mat-option value="MANAGER">MANAGER</mat-option>
              <mat-option value="TECH">TECH</mat-option>
            </mat-select>
          </td>
        </ng-container>

        <!-- Active -->
        <ng-container matColumnDef="active">
          <th mat-header-cell *matHeaderCellDef sticky>Active</th>
          <td mat-cell *matCellDef="let u">
            <mat-slide-toggle
              [checked]="u.is_active"
              [disabled]="!isAdmin()"
              (change)="toggleActive(u, $event.checked)">
            </mat-slide-toggle>
          </td>
        </ng-container>

        <!-- ✅ Temp password column (Admin view) -->
        <ng-container matColumnDef="temp">
          <th mat-header-cell *matHeaderCellDef sticky>Temp Password</th>
          <td mat-cell *matCellDef="let u">
            <ng-container *ngIf="isAdmin()">
              <code class="tp">{{ tempPwFor(u.id) || '—' }}</code>
            </ng-container>
          </td>
        </ng-container>

        <!-- Actions -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef sticky class="center">Actions</th>
          <td mat-cell *matCellDef="let u" class="center">
            <button
              mat-stroked-button
              class="btn-ghost"
              (click)="resetPassword(u)"
              matTooltip="Issue new temporary password"
              [disabled]="!isAdmin()">
              <mat-icon>password</mat-icon>
              <span>Reset</span>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="cols"></tr>
        <tr mat-row *matRowDef="let row; columns: cols;" class="trow"></tr>
      </table>
    </div>
  </section>
</div>